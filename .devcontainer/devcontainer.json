import streamlit as st
from datetime import datetime, date
from fpdf import FPDF
import gspread
from google.oauth2.service_account import Credentials

# -------------------------------
# CONFIGURA√á√ÉO DA P√ÅGINA
# -------------------------------
st.set_page_config(
    page_title="Gerador de Relat√≥rios ‚Äì Controladoria",
    layout="wide"
)

# -------------------------------
# CONSTANTES
# -------------------------------
ACOMPANHADORA_FIXA = "Isabele Dandara"
SETOR_FIXO = "Controladoria - Economato"
NOME_ABA_SHEETS = "Hist√≥rico"

SETORES_PADRAO = [
    "Ass. Comunit√°ria",
    "Previd√™ncia Brasil",
    "Sinodalidade",
    "Ass. Mission√°ria",
    "Constru√ß√£o Igreja",
    "Discipulado Eus√©bio",
    "Discipulado Pacajus",
    "Discipulado Quixad√°",
    "Fundo dos Necessitados",
    "Fundo Eclesial",
    "Instituto Parresia",
    "Lit. Sacramental",
    "Oficina Dis. Eus√©bio",
    "Oficina Dis. Pacajus",
    "Oficina Dis. Quixad√°",
    "Promo√ß√£o Humana",
    "Seminaristas",
    "Lan√ßai as Redes"
]

TIPOS_CONTA = [
    "Banco",
    "Caixa",
    "Maquineta",
    "Cart√£o Pr√©-pago",
    "Cart√£o de Cr√©dito"
]

# -------------------------------
# GOOGLE SHEETS
# -------------------------------
def conectar_sheets():
    scopes = ["https://www.googleapis.com/auth/spreadsheets"]
    creds = Credentials.from_service_account_info(
        st.secrets["google_service_account"],
        scopes=scopes
    )
    client = gspread.authorize(creds)
    return client


def salvar_historico(linha):
    client = conectar_sheets()
    planilha = client.open_by_key(st.secrets["SHEET_ID"])
    aba = planilha.worksheet(NOME_ABA_SHEETS)
    aba.append_row(linha, value_input_option="USER_ENTERED")


# -------------------------------
# PDF
# -------------------------------
class PDF(FPDF):
    def header(self):
        self.set_font("Arial", "B", 14)
        self.cell(0, 10, self.titulo, ln=True)
        self.ln(4)


def gerar_pdf(dados):
    pdf = PDF()
    pdf.titulo = dados["titulo"]
    pdf.add_page()
    pdf.set_font("Arial", size=10)

    def linha(titulo, valor):
        pdf.multi_cell(0, 6, f"{titulo}: {valor}")
        pdf.ln(1)

    linha("Acompanhadora", ACOMPANHADORA_FIXA)
    linha("Setor", SETOR_FIXO)
    linha("Sistema financeiro", dados["sistema"])
    linha("Respons√°vel", dados["responsavel"])
    linha("Data e hora", dados["data_hora"])
    linha("Per√≠odo analisado", f"{dados['periodo_inicio']} a {dados['periodo_fim']}")

    pdf.ln(3)
    pdf.set_font("Arial", "B", 11)
    pdf.cell(0, 8, "Contas analisadas", ln=True)
    pdf.set_font("Arial", size=10)

    for c in dados["contas"]:
        pdf.ln(2)
        pdf.set_font("Arial", "B", 10)
        pdf.cell(0, 6, f"{c['tipo']} ‚Äì {c['nome']}", ln=True)
        pdf.set_font("Arial", size=10)

        linha("Extrato banc√°rio", c["extrato"])
        linha("Concilia√ß√µes pendentes", c["conciliacoes"])

        if c["tipo"] == "Caixa":
            linha("Saldo do caixa", c["saldo_caixa"])

        linha("Provis√£o (contas a pagar)", c["provisao"])
        linha("Documentos", c["documentos"])
        linha("Prazo para regulariza√ß√£o", c["prazo"])
        linha("Observa√ß√µes", c["observacoes"])

    return pdf.output(dest="S").encode("latin-1")


# -------------------------------
# INTERFACE
# -------------------------------
st.title("üìä Acompanhamento de Setores ‚Äì Controladoria")

col1, col2, col3 = st.columns(3)

with col1:
    setores_selecionados = st.multiselect(
        "Setor analisado",
        SETORES_PADRAO
    )

with col2:
    sistema_financeiro = st.selectbox(
        "Sistema financeiro analisado",
        ["Conta Azul", "Omie"]
    )

with col3:
    responsavel = st.text_input("Respons√°vel")

st.divider()

col4, col5 = st.columns(2)

with col4:
    periodo_inicio = st.date_input("Per√≠odo analisado ‚Äì in√≠cio")

with col5:
    periodo_fim = st.date_input("Per√≠odo analisado ‚Äì fim")

st.divider()

# -------------------------------
# CONTAS
# -------------------------------
st.subheader("Contas analisadas")

if "contas" not in st.session_state:
    st.session_state.contas = []

if st.button("‚ûï Adicionar conta"):
    st.session_state.contas.append({})

for i, conta in enumerate(st.session_state.contas):
    st.markdown(f"### Conta {i + 1}")

    tipo = st.selectbox(
        "Tipo de conta",
        TIPOS_CONTA,
        key=f"tipo_{i}"
    )

    nome = st.text_input(
        "Nome da conta",
        key=f"nome_{i}"
    )

    extrato = st.selectbox(
        "Extrato banc√°rio",
        ["Em dia", "Pendente"],
        key=f"extrato_{i}"
    )

    conciliacoes = st.text_input(
        "Concilia√ß√µes pendentes",
        key=f"conc_{i}"
    )

    saldo_caixa = ""
    if tipo == "Caixa":
        saldo_caixa = st.text_input(
            "Saldo do caixa at√© o per√≠odo analisado",
            key=f"saldo_{i}"
        )

    provisao = st.selectbox(
        "Provis√£o (contas a pagar)",
        ["Sim", "N√£o"],
        key=f"prov_{i}"
    )

    documentos = st.selectbox(
        "Documentos",
        ["Sim", "N√£o", "Parcialmente"],
        key=f"doc_{i}"
    )

    prazo = st.text_input(
        "Prazo para regulariza√ß√£o (dd/mm/aaaa)",
        key=f"prazo_{i}"
    )

    observacoes = st.text_area(
        "Observa√ß√µes",
        key=f"obs_{i}"
    )

    st.session_state.contas[i] = {
        "tipo": tipo,
        "nome": nome,
        "extrato": extrato,
        "conciliacoes": conciliacoes,
        "saldo_caixa": saldo_caixa,
        "provisao": provisao,
        "documentos": documentos,
        "prazo": prazo,
        "observacoes": observacoes
    }

    st.divider()

# -------------------------------
# SALVAR E GERAR
# -------------------------------
if st.button("üìÑ Gerar relat√≥rio e salvar hist√≥rico"):
    data_hora = datetime.now().strftime("%d/%m/%Y %H:%M")

    titulo = "Acompanhamento " + " e ".join(setores_selecionados)

    for setor in setores_selecionados:
        for c in st.session_state.contas:
            salvar_historico([
                data_hora,
                ACOMPANHADORA_FIXA,
                setor,
                sistema_financeiro,
                responsavel,
                periodo_inicio.strftime("%d/%m/%Y"),
                periodo_fim.strftime("%d/%m/%Y"),
                c["tipo"],
                c["nome"],
                c["extrato"],
                c["conciliacoes"],
                c["saldo_caixa"],
                c["provisao"],
                c["documentos"],
                c["prazo"],
                c["observacoes"]
            ])

    pdf_bytes = gerar_pdf({
        "titulo": titulo,
        "sistema": sistema_financeiro,
        "responsavel": responsavel,
        "data_hora": data_hora,
        "periodo_inicio": periodo_inicio.strftime("%d/%m/%Y"),
        "periodo_fim": periodo_fim.strftime("%d/%m/%Y"),
        "contas": st.session_state.contas
    })

    st.success("Relat√≥rio gerado e hist√≥rico salvo com sucesso!")

    st.download_button(
        "‚¨áÔ∏è Baixar PDF",
        pdf_bytes,
        file_name=f"{titulo}.pdf",
        mime="application/pdf"
    )
